<!DOCTYPE html>
<html lang="en">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>TEKS Learning Portal</title>
 <script src="https://cdn.tailwindcss.com"></script>
 <script type="module">
 import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
 import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
 import { getFirestore, doc, onSnapshot, collection, setDoc, query, limit, writeBatch, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
 import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

 // Set Firebase logging level to Debug
 setLogLevel('Debug');

 // --- GLOBAL VARIABLES & FIREBASE SETUP ---
 const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
 const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
 const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
 const NUM_QUESTIONS = 10; // Default number of questions for practice

 let app, db, auth, userId = null;
 let currentView = 'home'; // 'home', 'tracker', 'contact', 'practice'
 let selectedGrade = null; // Currently expanded grade on home view
 let selectedTEKS = null; // Currently selected TEKS object
 let teksProgressMap = new Map(); // {teksId: {status, mastery, ...}}
 let allTEKS = []; // Array to store all TEKS data
 
 let currentQuiz = {
 teksId: null,
 questions: [],
 currentQuestionIndex: 0,
 score: 0,
 // selectedAnswer is now managed within the question object in the questions array
 };

 // --- DUMMY DATA ---
 const TEKS_DATA = {
 '6th Grade Math': [
 { id: '6.1A', title: 'Ratios and Rates', grade: 6, description: 'Representing ratios and rates with concrete models, fractions, and decimals.' },
 { id: '6.2A', title: 'Integers and Opposites', grade: 6, description: 'Locating, comparing, and ordering integers and their opposites.' },
 { id: '6.3A', title: 'Area and Perimeter', grade: 6, description: 'Calculating the area of rectangles, parallelograms, trapezoids, and triangles.' },
 { id: '6.4B', title: 'Unit Conversion', grade: 6, description: 'Converting between measurement systems.' },
 { id: '6.5C', title: 'Equations and Inequalities', grade: 6, description: 'Solving one-variable, one-step equations and inequalities.' }
 ],
 '7th Grade Math': [
 { id: '7.1A', title: 'Proportional Relationships', grade: 7, description: 'Applying and solving problems involving proportional relationships.' },
 { id: '7.2A', title: 'Probability', grade: 7, description: 'Determining experimental and theoretical probability.' },
 { id: '7.3A', title: 'Surface Area & Volume', grade: 7, description: 'Calculating surface area and volume of prisms and pyramids.' },
 { id: '7.4D', title: 'Circle Geometry', grade: 7, description: 'Determining the circumference and area of circles.' }
 ],
 '8th Grade Math': [
 { id: '8.1A', title: 'Pythagorean Theorem', grade: 8, description: 'Using the Pythagorean Theorem and its converse to solve problems.' },
 { id: '8.2A', title: 'Transformations', grade: 8, description: 'Identifying and applying transformations including translations, rotations, and reflections.' },
 { id: '8.3A', title: 'Linear Equations', grade: 8, description: 'Solving one-variable equations with variables on both sides.' },
 { id: '8.4B', title: 'Functions', grade: 8, description: 'Identifying functions using graphs and tables.' }
 ]
 };

 // --- FIREBASE INITIALIZATION AND AUTH ---
 function initializeFirebase() {
 try {
 if (Object.keys(firebaseConfig).length === 0) {
 return; // Skip if config is missing
 }
 app = initializeApp(firebaseConfig);
 db = getFirestore(app);
 auth = getAuth(app);
 
 onAuthStateChanged(auth, async (user) => {
 if (user) {
 userId = user.uid;
 document.getElementById('user-id-display').textContent = `User ID: ${userId}`;
 startDataListeners();
 } else {
 try {
 if (initialAuthToken) {
 await signInWithCustomToken(auth, initialAuthToken);
 } else {
 await signInAnonymously(auth);
 }
 } catch (error) {
 console.error("Authentication failed:", error);
 }
 }
 });
 } catch (error) {
 console.error("Error initializing Firebase:", error);
 }
 }

 // --- FIRESTORE LISTENERS AND PATHS ---
 const getTEKSCollectionPath = () => `artifacts/${appId}/public/data/teks_list`;
 const getUserProgressCollectionPath = (uid) => `artifacts/${appId}/users/${uid}/user_teks_progress`;

 function startDataListeners() {
 if (!db || !userId) return;

 // 1. Listen to the main TEKS list
 onSnapshot(collection(db, getTEKSCollectionPath()), (snapshot) => {
 allTEKS = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
 renderApp(); 
 }, (error) => console.error("Error fetching TEKS list:", error));

 // 2. Listen to the user's progress data
 onSnapshot(collection(db, getUserProgressCollectionPath(userId)), (snapshot) => {
 teksProgressMap.clear();
 snapshot.docs.forEach(doc => teksProgressMap.set(doc.id, { id: doc.id, ...doc.data() }));
 renderApp(); 
 }, (error) => console.error("Error fetching user progress:", error));
 }

 // --- DATA MANIPULATION FUNCTIONS ---
 async function updateProgress(teksId, status, mastery = 0) {
 if (!userId || !db) return console.error("User or database not ready.");

 const progressRef = doc(db, getUserProgressCollectionPath(userId), teksId);
 const data = {
 teksId: teksId,
 status: status,
 updatedAt: new Date().getTime()
 };

 if (status === 'finished') {
 data.mastery = mastery;
 }

 try {
 await setDoc(progressRef, data, { merge: true });
 showMessageBox(`Progress for ${teksId} updated to ${status}.`, 'success');
 } catch (error) {
 console.error("Error updating TEKS progress:", error);
 showMessageBox("Error updating progress. See console.", 'error');
 }
 }

 window.updateProgress = updateProgress;
 
 window.markFinished = (teksId) => {
 const selectElement = document.getElementById(`mastery-level-${teksId}`);
 if (selectElement) {
 const mastery = parseInt(selectElement.value, 10);
 updateProgress(teksId, 'finished', mastery);
 }
 }
 
 // --- DUMMY DATA INJECTION ---
 async function injectDummyTEKS() {
 if (!db) return;
 const teksRef = collection(db, getTEKSCollectionPath());
 const snapshot = await getDocs(query(teksRef, limit(1)));

 if (snapshot.empty) {
 console.log("Injecting dummy TEKS data...");
 const batch = writeBatch(db);
 Object.keys(TEKS_DATA).forEach(gradeKey => {
 TEKS_DATA[gradeKey].forEach(teks => {
 const docRef = doc(teksRef, teks.id);
 batch.set(docRef, teks);
 });
 });
 await batch.commit();
 console.log("Dummy TEKS data injected successfully.");
 }
 }

 // --- QUIZ LOGIC FUNCTIONS ---
 
 function generateQuestionForTEKS(teks) {
 let question = {};
 const rand = Math.floor(Math.random() * 100);

 switch (teks.id) {
 case '6.1A': // Ratios and Rates
 const r = (rand % 5) + 2; // Ratio part 1 (2-6)
 const d = (rand % 5) + 3; // Ratio part 2 (3-7)
 const totalRatio = r + d;
 const value = (rand % 10) + 1;
 const totalItems = totalRatio * value;

 question.text = `A basket contains apples and oranges in a ratio of ${r}:${d}. If there are a total of ${totalItems} pieces of fruit, how many apples are there?`;
 question.correctAnswer = `${r * value}`;
 
 const correctValue = r * value;
 question.options = [
 `${correctValue}`, // Correct
 `${d * value}`,
 `${totalItems - correctValue}`,
 `${correctValue + d}`
 ].sort(() => Math.random() - 0.5); // Shuffle options
 break;

 case '6.5C': // Equations and Inequalities (One-step linear)
 const x = (rand % 10) + 5;
 const a = (rand % 5) + 2;
 const b = a * x + (rand % 2 === 0 ? 0 : -1 * a); // Simple variation
 const operator = rand % 2 === 0 ? '+' : '-';
 
 if (operator === '+') {
 question.text = `Solve the equation for $x$: $$x + ${a} = ${x + a}$$`;
 question.correctAnswer = `${x}`;
 } else {
 question.text = `Solve the equation for $x$: $$x - ${a} = ${x - a}$$`;
 question.correctAnswer = `${x}`;
 }
 
 question.options = [
 `${x}`, // Correct
 `${x + 1}`,
 `${x - 1}`,
 `${a + x}`
 ].sort(() => Math.random() - 0.5);
 break;
 
 case '7.4D': // Circle Geometry (Circumference)
 const radius = (rand % 8) + 3;
 const diameter = radius * 2;
 // Use simple integer answer approximation for mock
 const circApprox = Math.round(diameter * 3.14); 
 
 question.text = `A circular pool has a diameter of ${diameter} meters. What is the approximate circumference? (Use $\\pi \\approx 3.14$)`;
 question.correctAnswer = `${circApprox}`;

 const optionA = circApprox;
 const optionB = Math.round(diameter * 2);
 const optionC = Math.round(diameter * 4);
 const optionD = Math.round(radius * 3.14);

 question.options = [`${optionA}`, `${optionB}`, `${optionC}`, `${optionD}`].sort(() => Math.random() - 0.5);
 break;

 default: // Default/Fallback question (Addition)
 const num1 = (rand % 50) + 1;
 const num2 = (rand % 50) + 1;
 const correctSum = num1 + num2;

 question.text = `Fallback Question (${teks.id}): What is the sum of ${num1} and ${num2}?`;
 question.correctAnswer = `${correctSum}`;
 
 question.options = [
 `${correctSum}`, // Correct
 `${num1 * num2}`,
 `${num1 - num2}`,
 `${correctSum + 5}`
 ].sort(() => Math.random() - 0.5);
 }
 return question;
 }


 function generateMockQuestions(teksId) {
 const teks = allTEKS.find(t => t.id === teksId);
 if (!teks) return [];

 const questions = [];
 for (let i = 1; i <= NUM_QUESTIONS; i++) {
 const newQ = generateQuestionForTEKS(teks);
 questions.push({
 id: i,
 text: newQ.text,
 options: newQ.options,
 correctAnswer: newQ.correctAnswer,
 isAnswered: false, // New state: Has the user selected an answer?
 isCorrect: null, // New state: Was the selected answer correct? (true/false)
 userSelected: null // New state: What the user selected
 });
 }
 return questions;
 }

 function simulateStartPractice(teksId) {
 closePracticeModal();
 const teks = allTEKS.find(t => t.id === teksId);
 if (!teks) return;

 // 1. Initialize Quiz State
 selectedTEKS = teks;
 currentQuiz.teksId = teksId;
 currentQuiz.questions = generateMockQuestions(teksId);
 currentQuiz.currentQuestionIndex = 0;
 currentQuiz.score = 0;
 updateProgress(teksId, 'in-progress'); // Update Firestore status

 // 2. Switch View
 currentView = 'practice';
 showMessageBox(`Starting practice for ${teksId} with ${NUM_QUESTIONS} questions!`, 'info');
 renderApp();
 }
 window.simulateStartPractice = simulateStartPractice;

 function handleAnswerSelection(answer) {
 const qIndex = currentQuiz.currentQuestionIndex;
 const currentQ = currentQuiz.questions[qIndex];

 // Prevent re-answering
 if (currentQ.isAnswered) return;

 currentQ.userSelected = answer;
 currentQ.isAnswered = true;

 // Check if the selected answer (string) equals the correct answer (string)
 const isCorrect = (currentQ.userSelected === currentQ.correctAnswer);
 currentQ.isCorrect = isCorrect;

 if (isCorrect) {
 currentQuiz.score += 1; // Gain 1 point
 showMessageBox("Correct! +1 Point!", 'success');
 } else {
 currentQuiz.score -= 1; // Lose 1 point
 showMessageBox("Incorrect. -1 Point.", 'error');
 }

 // Important: Re-render to show immediate feedback (score, highlights)
 renderCurrentQuestion();
 }
 window.handleAnswerSelection = handleAnswerSelection;

 function goToNextQuestion() {
 const currentQ = currentQuiz.questions[currentQuiz.currentQuestionIndex];
 
 if (!currentQ.isAnswered) {
 showMessageBox("Please select an answer before proceeding.", 'info');
 return;
 }

 currentQuiz.currentQuestionIndex++;
 
 if (currentQuiz.currentQuestionIndex < NUM_QUESTIONS) {
 renderCurrentQuestion();
 } else {
 submitQuiz(currentQuiz.teksId);
 }
 }
 window.goToNextQuestion = goToNextQuestion;

 function submitQuiz(teksId) {
 const finalScore = currentQuiz.score;
 const totalQuestions = NUM_QUESTIONS;
 let mastery = 1; // Default low mastery (1/5)

 // Mastery calculation based on score (simulated)
 // A score of 0 or less is considered level 1
 if (finalScore >= totalQuestions * 0.8) mastery = 5; // 8/10 or better
 else if (finalScore >= totalQuestions * 0.6) mastery = 4; // 6/10 or better
 else if (finalScore >= totalQuestions * 0.4) mastery = 3; // 4/10 or better
 else if (finalScore >= totalQuestions * 0.2) mastery = 2; // 2/10 or better
 else mastery = 1;
 
 // Update Firestore
 updateProgress(teksId, 'finished', mastery);
 
 showMessageBox(`Quiz finished! Final Score: ${finalScore}. Mastery Level: ${mastery}`, 'success');

 // Reset state and return to home
 currentQuiz.teksId = null;
 selectedTEKS = null;
 currentView = 'home';
 renderApp();
 }
 window.submitQuiz = submitQuiz;

 // --- MODAL LOGIC ---
 function openPracticeModal(teks) {
 const modal = document.getElementById('practice-modal');
 const content = document.getElementById('practice-modal-content');
 const progress = teksProgressMap.get(teks.id) || { status: 'pending', mastery: 0 };
 const isFinished = progress.status === 'finished';

 let buttonContent;
 if (isFinished) {
 buttonContent = `
 <div class="text-xl font-bold text-green-600">Mastery Achieved (Level ${progress.mastery}/5)</div>
 `;
 } else {
 buttonContent = `
 <button onclick="simulateStartPractice('${teks.id}')" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition duration-200 flex items-center space-x-2">
 <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"></path></svg>
 <span>Start Session</span>
 </button>
 `;
 }

 content.innerHTML = `
 <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-lg relative">
 <button onclick="closePracticeModal()" class="absolute top-3 right-3 text-gray-400 hover:text-gray-600 transition">
 <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
 </button>
 
 <h3 class="text-2xl font-extrabold text-indigo-800 mb-2">Practice Session Ready</h3>
 <p class="text-xl text-gray-700 mb-6">You will be practicing this TEKS:</p>

 <div class="bg-indigo-50 p-4 rounded-lg mb-6 border-l-4 border-indigo-500">
 <p class="text-lg font-semibold text-gray-900">${teks.id}: ${teks.title}</p>
 <p class="text-sm text-gray-600">${teks.description}</p>
 </div>

 <div class="flex justify-between items-center mb-6">
 <p class="text-lg font-medium text-gray-700">Number of Questions:</p>
 <span class="text-2xl font-extrabold text-indigo-600">${NUM_QUESTIONS}</span>
 </div>

 <div class="flex justify-end">
 ${buttonContent}
 </div>
 </div>
 `;
 modal.classList.remove('hidden');
 }

 function closePracticeModal() {
 document.getElementById('practice-modal').classList.add('hidden');
 selectedTEKS = null;
 }
 window.closePracticeModal = closePracticeModal; 

 // --- UI & RENDERING FUNCTIONS ---
 
 function toggleView(view) {
 currentView = view;
 renderApp();
 }
 window.toggleView = toggleView;

 function toggleGrade(grade) {
 selectedGrade = selectedGrade === grade ? null : grade;
 renderApp();
 }
 window.toggleGrade = toggleGrade;

 function selectTEKS(teksId) {
 const teks = allTEKS.find(t => t.id === teksId);
 if (teks) {
 selectedTEKS = teks;
 openPracticeModal(teks);
 }
 }
 window.selectTEKS = selectTEKS;

 function renderApp() {
 const container = document.getElementById('main-content');
 container.innerHTML = '';
 
 // Update nav buttons
 document.querySelectorAll('.nav-btn').forEach(btn => {
 btn.classList.remove('bg-indigo-700', 'text-white');
 btn.classList.add('text-indigo-700', 'hover:bg-indigo-100');
 });
 document.getElementById(`btn-${currentView === 'practice' ? 'home' : currentView}`).classList.add('bg-indigo-700', 'text-white');
 document.getElementById(`btn-${currentView === 'practice' ? 'home' : currentView}`).classList.remove('text-indigo-700', 'hover:bg-indigo-100');


 if (currentView === 'home') return renderHome(container);
 if (currentView === 'tracker') return renderTrackerDashboard(container);
 if (currentView === 'contact') return renderContact(container);
 if (currentView === 'practice') return renderPracticeQuiz(container);
 }

 // --- View 1: Home (Grade Sections) ---
 function renderHome(container) {
 container.className = 'py-8 px-4 max-w-4xl mx-auto';
 const sortedTEKS = allTEKS.reduce((acc, teks) => {
 const grade = `${teks.grade}th Grade Math`;
 if (!acc[grade]) acc[grade] = [];
 acc[grade].push(teks);
 return acc;
 }, {});

 Object.keys(TEKS_DATA).forEach(gradeTitle => {
 const teksList = sortedTEKS[gradeTitle] || [];
 const isExpanded = selectedGrade === gradeTitle;
 const progressCount = teksList.filter(t => teksProgressMap.has(t.id) && teksProgressMap.get(t.id).status === 'finished').length;
 
 let gradeHtml = `
 <div class="bg-white rounded-xl shadow-lg mb-6 overflow-hidden">
 <button onclick="window.toggleGrade('${gradeTitle}')" class="w-full text-left p-6 flex justify-between items-center transition duration-200 ${isExpanded ? 'bg-indigo-50' : 'bg-white hover:bg-gray-50'}">
 <h2 class="text-2xl font-bold text-indigo-800">${gradeTitle}</h2>
 <span class="text-sm font-medium text-gray-500">${progressCount}/${teksList.length} Completed</span>
 <svg class="w-6 h-6 text-indigo-500 transform ${isExpanded ? 'rotate-180' : ''} transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
 </button>
 ${isExpanded ? renderTEKSListForGrade(teksList, gradeTitle) : ''}
 </div>
 `;
 container.innerHTML += gradeHtml;
 });
 }

 function renderTEKSListForGrade(teksList, gradeKey) {
 return `
 <div class="p-4 border-t border-indigo-100">
 <ul class="space-y-3">
 ${teksList.map(teks => {
 const progress = teksProgressMap.get(teks.id) || { status: 'pending' };
 const status = progress.status;
 
 let statusBadge = '';
 if (status === 'finished') {
 statusBadge = `<span class="px-2 py-1 text-xs font-semibold text-green-700 bg-green-200 rounded-full">Done (M: ${progress.mastery})</span>`;
 } else if (status === 'in-progress') {
 statusBadge = `<span class="px-2 py-1 text-xs font-semibold text-yellow-700 bg-yellow-200 rounded-full">In Progress</span>`;
 } else {
 statusBadge = `<span class="px-2 py-1 text-xs font-semibold text-gray-700 bg-gray-200 rounded-full">Pending</span>`;
 }

 return `
 <li onclick="window.selectTEKS('${teks.id}')" class="p-3 rounded-lg cursor-pointer flex justify-between items-center transition duration-150 ease-in-out hover:bg-indigo-100">
 <div>
 <p class="text-base font-semibold text-gray-800">${teks.id}: ${teks.title}</p>
 <p class="text-sm text-gray-500">${teks.description}</p>
 </div>
 ${statusBadge}
 </li>
 `;
 }).join('')}
 </ul>
 </div>
 `;
 }
 
 // --- View 4: Practice Quiz ---
 function renderPracticeQuiz(container) {
 if (!currentQuiz.teksId) {
 currentView = 'home';
 return renderApp();
 }

 const teks = selectedTEKS;
 const questionNumber = currentQuiz.currentQuestionIndex + 1;
 const totalQuestions = NUM_QUESTIONS;
 const completionPercentage = (questionNumber / totalQuestions) * 100;

 container.className = 'py-8 px-4 max-w-2xl mx-auto';
 container.innerHTML = `
 <div class="bg-white p-6 rounded-xl shadow-xl">
 <h2 class="text-2xl font-extrabold text-indigo-700 mb-4">${teks.id}: ${teks.title} Practice</h2>
 
 <!-- Progress Bar -->
 <div class="w-full bg-gray-200 rounded-full h-2.5 mb-6">
 <div class="bg-indigo-600 h-2.5 rounded-full" style="width: ${completionPercentage}%; transition: width 0.3s;"></div>
 </div>
 
 <div id="quiz-question-container">
 <!-- Question content will be rendered here -->
 </div>
 
 </div>
 `;
 renderCurrentQuestion();
 }
 
 function renderCurrentQuestion() {
 const qContainer = document.getElementById('quiz-question-container');
 if (!qContainer) return; // Should only happen if renderPracticeQuiz hasn't run yet

 const qIndex = currentQuiz.currentQuestionIndex;
 const question = currentQuiz.questions[qIndex];
 const isLastQuestion = qIndex === NUM_QUESTIONS - 1;

 const nextButtonText = isLastQuestion ? 'Submit Quiz' : 'Next Question';
 const nextButtonAction = 'window.goToNextQuestion()';
 
 const isAnswered = question.isAnswered;
 const isCorrect = question.isCorrect;
 const isButtonEnabled = isAnswered;

 qContainer.innerHTML = `
 <div class="mb-6">
 <p class="text-lg font-semibold text-indigo-600 mb-2">Question ${qIndex + 1} of ${NUM_QUESTIONS}</p>
 <p class="text-xl font-medium text-gray-800">${question.text}</p>
 
 <!-- Immediate Feedback Box -->
 ${isAnswered ? `
 <div class="mt-4 p-3 rounded-lg font-bold text-center text-xl shadow-md ${isCorrect ? 'bg-green-100 text-green-700 border-2 border-green-500' : 'bg-red-100 text-red-700 border-2 border-red-500'}">
 ${isCorrect ? 'üéâ Correct Answer! +1 Point.' : `‚ùå Incorrect Answer. -1 Point. The correct answer was: ${question.correctAnswer}`}
 </div>
 ` : ''}
 </div>

 <div class="space-y-3 mb-8">
 ${question.options.map(option => {
 const isSelected = question.userSelected === option;
 const isCorrectOption = question.correctAnswer === option;
 
 let buttonClasses = 'bg-white hover:bg-gray-50 border-gray-300';
 let onClick = isAnswered ? '' : `window.handleAnswerSelection('${option.replace(/'/g, "\\'")}')`;
 let cursor = isAnswered ? 'cursor-default' : 'cursor-pointer';

 // Logic for highlighting after answer is selected
 if (isAnswered) {
 if (isCorrectOption) {
 // Highlight correct answer green
 buttonClasses = 'bg-green-100 border-green-500 shadow-md ring-2 ring-green-500 text-green-800 font-bold';
 } else if (isSelected && !isCorrectOption) {
 // Highlight user's incorrect choice red
 buttonClasses = 'bg-red-100 border-red-500 shadow-md ring-2 ring-red-500 text-red-800 font-bold line-through';
 } else {
 // Default look for unselected wrong options
 buttonClasses = 'bg-gray-50 border-gray-200 text-gray-500';
 }
 } else if (isSelected) {
 // Highlight user's selection blue BEFORE checking
 buttonClasses = 'bg-indigo-200 border-indigo-500 shadow-md ring-2 ring-indigo-500';
 }
 
 return `
 <button 
 onclick="${onClick}" 
 ${isAnswered ? 'disabled' : ''}
 class="w-full text-left p-4 border rounded-lg transition duration-150 ease-in-out ${buttonClasses} ${cursor}">
 ${option}
 </button>
 `;
 }).join('')}
 </div>

 <div class="flex justify-between items-center pt-4 border-t border-gray-100">
 <span class="text-md font-semibold text-gray-600">Current Score: 
 <span class="${currentQuiz.score >= 0 ? 'text-green-600' : 'text-red-600'} font-extrabold text-lg">
 ${currentQuiz.score}
 </span>
 </span>
 <button 
 onclick="${nextButtonAction}" 
 ${isButtonEnabled ? '' : 'disabled'}
 class="px-6 py-3 rounded-lg font-bold transition duration-200 
 ${isButtonEnabled ? 'bg-indigo-600 hover:bg-indigo-700 text-white shadow-lg' : 'bg-gray-300 text-gray-500 cursor-not-allowed'}"
 >
 ${nextButtonText}
 </button>
 </div>
 `;
 }

 // --- View 2: Progress Tracker (No changes needed) ---
 function renderTrackerDashboard(container) {
 container.className = 'py-8 px-4 max-w-6xl mx-auto';
 const progressData = allTEKS.map(teks => ({
 ...teks,
 ...teksProgressMap.get(teks.id)
 })).sort((a, b) => a.grade - b.grade); 

 const total = progressData.length;
 const finished = progressData.filter(p => p.status === 'finished').length;
 const inProgress = progressData.filter(p => p.status === 'in-progress').length;
 const completionPercentage = total > 0 ? ((finished / total) * 100).toFixed(1) : 0;
 const averageMastery = finished > 0 ? (progressData.filter(p => p.status === 'finished').reduce((sum, p) => sum + p.mastery, 0) / finished).toFixed(2) : 0;

 container.innerHTML = `
 <h2 class="text-3xl font-extrabold text-indigo-800 mb-6 text-center">Your Progress Tracker</h2>
 <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
 <div class="bg-white p-4 rounded-xl shadow-md border-b-4 border-indigo-500 text-center"><p class="text-sm text-gray-500">Total TEKS</p><p class="text-2xl font-bold">${total}</p></div>
 <div class="bg-white p-4 rounded-xl shadow-md border-b-4 border-green-500 text-center"><p class="text-sm text-gray-500">Completed</p><p class="text-2xl font-bold text-green-600">${finished} (${completionPercentage}%)</p></div>
 <div class="bg-white p-4 rounded-xl shadow-md border-b-4 border-yellow-500 text-center"><p class="text-sm text-gray-500">In Progress</p><p class="text-2xl font-bold text-yellow-600">${inProgress}</p></div>
 <div class="bg-white p-4 rounded-xl shadow-md border-b-4 border-gray-500 text-center"><p class="text-sm text-gray-500">Avg. Mastery</p><p class="text-2xl font-bold">${averageMastery} / 5</p></div>
 </div>
 
 <div class="bg-white p-6 rounded-xl shadow-xl overflow-x-auto">
 <table class="min-w-full divide-y divide-gray-200">
 <thead class="bg-gray-50">
 <tr>
 <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">TEKS ID</th>
 <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Grade</th>
 <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
 <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mastery</th>
 <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Title</th>
 </tr>
 </thead>
 <tbody class="bg-white divide-y divide-gray-200">
 ${progressData.map(p => {
 const status = p.status || 'pending';
 let statusClass = 'bg-gray-100 text-gray-800';
 if (status === 'finished') statusClass = 'bg-green-100 text-green-800';
 if (status === 'in-progress') statusClass = 'bg-yellow-100 text-yellow-800';

 return `
 <tr>
 <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${p.id}</td>
 <td class="px-4 py-4 whitespace-nowrap text-sm text-indigo-600">${p.grade}th</td>
 <td class="px-4 py-4 whitespace-nowrap">
 <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">${status.toUpperCase().replace('-', ' ')}</span>
 </td>
 <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">${status === 'finished' ? `${p.mastery}/5` : 'N/A'}</td>
 <td class="px-4 py-4 text-sm text-gray-600 max-w-xs truncate">${p.title}</td>
 </tr>
 `;
 }).join('')}
 </tbody>
 </table>
 </div>
 `;
 }

 // --- View 3: Contact & Tutoring (No changes needed) ---
 function renderContact(container) {
 container.className = 'py-8 px-4 max-w-xl mx-auto';
 const randomPhoneNumber = `(800) 555-${Math.floor(Math.random() * 9000) + 1000}`;

 container.innerHTML = `
 <div class="bg-white p-8 rounded-xl shadow-xl text-center">
 <h2 class="text-3xl font-extrabold text-indigo-800 mb-4">Tutoring & Contact Information</h2>
 <p class="text-lg text-gray-600 mb-8">Ready to boost your math skills? Sign up for one-on-one tutoring today!</p>
 
 <div class="space-y-4 mb-8">
 <div class="bg-indigo-50 p-4 rounded-lg border-l-4 border-indigo-500 shadow-sm">
 <p class="text-xl font-semibold text-gray-800">1 Hour Session</p>
 <p class="text-3xl font-extrabold text-indigo-600">$15</p>
 </div>
 <div class="bg-indigo-50 p-4 rounded-lg border-l-4 border-indigo-500 shadow-sm">
 <p class="text-xl font-semibold text-gray-800">2 Hour Session</p>
 <p class="text-3xl font-extrabold text-indigo-600">$25</p>
 </div>
 </div>

 <p class="text-xl font-semibold text-gray-700 mb-2">To Sign Up:</p>
 <a href="tel:${randomPhoneNumber.replace(/[() -]/g, '')}" class="inline-block text-2xl font-extrabold text-green-600 bg-green-100 p-3 rounded-xl hover:bg-green-200 transition duration-200">${randomPhoneNumber}</a>
 <p class="text-sm text-gray-500 mt-2">(Call this random number to schedule)</p>
 </div>
 `;
 }

 // --- MESSAGE BOX FUNCTION ---
 let messageBoxTimeout;
 function showMessageBox(message, type = 'info') {
 const box = document.getElementById('message-box');
 let bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
 
 box.textContent = message;
 box.className = `fixed bottom-4 right-4 p-4 rounded-lg shadow-2xl transition-opacity duration-300 ${bgColor} text-white z-50`;
 box.style.opacity = 1;

 clearTimeout(messageBoxTimeout);
 messageBoxTimeout = setTimeout(() => {
 box.style.opacity = 0;
 }, 3000);
 }

 // --- INITIALIZATION ---
 window.onload = () => {
 initializeFirebase();
 injectDummyTEKS(); // Attempt to populate if empty
 renderApp();
 };

 </script>
 <style>
 @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
 body {
 font-family: 'Inter', sans-serif;
 background-color: #f3f4f6;
 min-height: 100vh;
 }
 </style>
</head>
<body>
 <div id="app" class="min-h-screen flex flex-col">
 <!-- Header / Navigation -->
 <header class="p-4 bg-white shadow-lg sticky top-0 z-20">
 <div class="max-w-7xl mx-auto flex justify-between items-center">
 <h1 class="text-3xl font-extrabold text-indigo-600">TEKS Learning</h1>
 <nav class="flex space-x-2 rounded-full bg-indigo-50 p-1">
 <!-- Note: Practice mode temporarily highlights 'Home' -->
 <button id="btn-home" onclick="toggleView('home')" class="nav-btn px-4 py-2 rounded-full font-semibold transition duration-200">
 Home
 </button>
 <button id="btn-tracker" onclick="toggleView('tracker')" class="nav-btn px-4 py-2 rounded-full font-semibold transition duration-200">
 Progress
 </button>
 <button id="btn-contact" onclick="toggleView('contact')" class="nav-btn px-4 py-2 rounded-full font-semibold transition duration-200">
 Tutoring
 </button>
 </nav>
 </div>
 </header>

 <!-- Main Content Container -->
 <div id="main-content" class="flex-grow p-6">
 <!-- Content injected here -->
 <div class="text-center p-8 text-gray-500">Loading application...</div>
 </div>
 
 <!-- User ID Display -->
 <div id="user-id-display" class="text-xs text-gray-400 absolute bottom-1 left-1">Loading User ID...</div>
 </div>
 
 <!-- MODAL FOR PRACTICE START -->
 <div id="practice-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center hidden">
 <div id="practice-modal-content" class="w-full mx-4">
 <!-- Modal Content Injected Here -->
 </div>
 </div>

 <!-- Floating Message Box -->
 <div id="message-box" class="fixed bottom-4 right-4 p-4 rounded-lg shadow-2xl transition-opacity duration-300 opacity-0 z-50"></div>
</body>
</html>
